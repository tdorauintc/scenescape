#!/bin/bash

# Copyright (C) 2022-2024 Intel Corporation
#
# This software and the related documents are Intel copyrighted materials,
# and your use of them is governed by the express license under which they
# were provided to you ("License"). Unless the License provides otherwise,
# you may not use, modify, copy, publish, distribute, disclose or transmit
# this software or the related documents without Intel's prior written permission.
#
# This software and the related documents are provided as is, with no express
# or implied warranties, other than those that are expressly stated in the License.

TEST_NAME="SAIL-T608"
echo "Executing: ${TEST_NAME}"

INPUT_FRAMES=5000
INPUT_RATE=30
NUMINPUTS=2
TARGET_RATE=40

DATA_BASE=sample_data
PREFIX=apriltag-cam

while [ $# -gt 0 -a x$(expr substr "${1:-empty}" 1 2) = "x--" ] ; do
  case "$1" in
    --target)
      TARGET_RATE=$2
      shift 2
      ;;
    --inputs)
      NUMINPUTS=$2
      shift 2
      ;;
    --prefix)
      PREFIX=$2
      shift 2
      ;;
    --datadir)
      DATA_BASE=$2
      shift 2
      ;;
    --frames)
      if [[ "$2" != "" && $2 -ge 0 && $2 -lt 100000 ]]
      then
        INPUT_FRAMES=$2
      fi
      shift 2
      ;;
    --rate)
      if [[ "$2" != "" && $2 -ge 0 && $2 -lt 91 ]]
      then
        INPUT_RATE=$2
      fi
      shift 2
      ;;
    *)
      shift 1
      ;;
  esac
done

if [[ ! -d ${DATA_BASE} ]]
then
  echo "Data directory (${DATA_BASE}) not found"
  echo "Create the directory and drop the corresponding dataset json files".
  echo "Note the data-set (sensor ids) should match the database."
  echo "${TEST_NAME}: FAIL"
  exit 1
fi

TESTBASE=tests/perf_tests

TESTINPUTS=""
for ((j=0; j < $NUMINPUTS; j++))
do
  printf -v k "%01d" $(($j + 1))
  TESTINPUTS="${TESTINPUTS} ${DATA_BASE}/${PREFIX}${k}.json"

  #Pre-process data if not available
  if [[ ! -f ${DATA_BASE}/${PREFIX}${k}.json ]]
  then
    if [[ "${DATA_BASE}" != "sample_data" ]]
    then
      echo "Can't find required input files in ${DATA_BASE}"
      echo "Make sure to drop the corresponding dataset json files in ${DATA_BASE}".
      echo "Note the data-set (sensor ids) should match the database."
      echo "${TEST_NAME}: FAIL"
      exit 1
    else
      echo "Can't find required input files in ${DATA_BASE}, generating. This may take a minute or two."
      ${TESTBASE}/tc_inference_performance.sh "apriltag,retail" "sample_data/apriltag-cam1.mp4 sample_data/apriltag-cam2.mp4 sample_data/apriltag-cam3.mp4" > /dev/null
    fi
  fi
done

export INPUT_FILES=$TESTINPUTS
export INPUT_FRAMES
export INPUT_RATE

echo "Running test on ${NUMINPUTS} streams, for $INPUT_FRAMES detections at $INPUT_RATE fps. Target rate desired is ${TARGET_RATE}"

#This file is generated by the test_sceneperf_json.sh script
LOGFILE=test_mqtt_recorder_log.txt
RUNFILE=test_scene_perf.txt

#Run the scene performance test.
${TESTBASE}/scene_perf/test_sceneperf_json.sh > ${RUNFILE} 2>&1
RESULT=$?

if [[ $RESULT -eq 0 ]]
then
  FINAL_RATE=$( grep "proc time" ${LOGFILE} | tail -n 1 | awk '{print $8}' | sed -e 's/[^0-9\.]//g' )
  FINAL_TIME=$( grep "proc time" ${LOGFILE} | tail -n 1 | awk '{print $5}' | sed -e 's/[^0-9\.]//g' )
  FELL_BEHIND=$( grep "FELL BEHIND" ${LOGFILE} | wc -l )

  if [[ -z "$FINAL_RATE" || -z "$FINAL_TIME" ]]
  then
    echo "Test failed running, check mqtt+scene log at ${LOGFILE} / execution log at ${RUNFILE}"
    RESULT=1
  else
    echo "Time per msg: ${FINAL_TIME} ms, RATE: ${FINAL_RATE} messages/s, ${FELL_BEHIND} FELL BEHIND messages observed."
  fi

  if [[ $FELL_BEHIND -ne 0 ]]
  then
    echo "Observed FELL BEHIND messages. Need to re-run with lower rate/number of inputs"
  elif [[ $RESULT -eq 0 ]]
  then
    rm ${LOGFILE} ${RUNFILE}
  fi

  if [[ -n ${TARGET_RATE} ]]
  then
    RESULT=$( awk -v tr="${TARGET_RATE}" -v fr="${FINAL_RATE}" 'BEGIN {printf (fr>=tr?0:1)}' )
    if [[ $RESULT -eq 0 ]]
    then
      echo "Reached at least ${TARGET_RATE} mps!"
    else
      echo "Failed to reach minimum rate!"
    fi
  fi
fi
if [[ $RESULT -ne 0 ]]
then
  echo "Test failed running !"
  echo "${RUNFILE}---"
  cat ${RUNFILE}
  echo "---"
  echo "${LOGFILE}---"
  cat ${LOGFILE}
  echo "---"
fi

if [[ $RESULT -eq 0 ]]
then
    echo "${TEST_NAME}: PASS"
else
    echo "${TEST_NAME}: FAIL"
fi

exit $RESULT
